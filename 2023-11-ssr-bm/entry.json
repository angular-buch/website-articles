{"slug":"2023-11-ssr-bm","html":"<p>Mit Angular 17 wurde der Build-Prozess für Server-Side Rendering (SSR) und Pre-Rendering grundlegend überarbeitet.\nIn diesem Blogpost stellen wir vor, welche Unterschiede für das Beispielprojekt &quot;BookMonkey&quot; aus dem Angular-Buch relevant sind.</p>\n<h2 id=\"der-neue-application-builder\">Der neue Application Builder</h2>\n<p>Mit Angular 17 wurde Server-Side Rendering noch tiefer in Angular integriert.\nSchon beim Anlegen eines neuen Projekts mit <code>ng new</code> können wir die Unterstützung für SSR sofort aktivieren.</p>\n<p>Um den gesamten Build-Prozess zu harmonisieren, wurde außerdem der neue <em>Application Builder</em> eingeführt: Er vereint den Build für Browser und Server, sodass beide Schritte mit einem Befehl gemeinsam erledigt werden können.</p>\n<p>Der neue Builder ist in neuen Projekten mit Angular 17 automatisch aktiv.\nWir haben darüber bereits im <a href=\"/blog/2023-11-angular17\">Blogpost zum Angular-Release 17</a> berichtet.</p>\n<h2 id=\"ssr-einrichten\">SSR einrichten</h2>\n<p>Um Server-Side Rendering und Pre-Rendering in einer bestehenden Anwendung einzurichten, wird ab sofort das neue Paket <code>@angular/ssr</code> verwendet.\nDas bisherige Paket <code>@nguniversal/express-engine</code>, das wir im Buch verwenden, wird nicht mehr genutzt.</p>\n<pre><code class=\"language-bash\">ng <span class=\"hljs-keyword\">add</span><span class=\"language-bash\"> @angular/ssr</span>\n</code></pre>\n<h2 id=\"unterschiede-in-den-generierten-dateien\">Unterschiede in den generierten Dateien</h2>\n<p>Nachdem die Einrichtung von SSR abgeschlossen ist, können wir die Änderungen an den Dateien nachvollziehen.\nWir haben im Buch ausführlich beschrieben, welche Aspekte dabei wichtig sind.\nDer grundlegende Ablauf ist noch immer der gleiche – der Code sieht jedoch anders aus.\nWir haben den Code im <a href=\"https://github.com/book-monkey5/16f-ssr\">GitHub-Repo für den BookMonkey</a> aktualisiert.</p>\n<h3 id=\"skripte-in-der-datei-packagejson\">Skripte in der Datei <code>package.json</code></h3>\n<p>Bisher wurden in der Datei <code>package.json</code> mehrere Skripte hinzugefügt, mit denen die Builder für SSR und Pre-Rendering angestoßen werden können.\nDa der Application Builder nun alle diese Aspekte übernimmt, wird nur noch ein einziges Skript hinzugefügt.\nEs ist dafür verantwortlich, die SSR-Anwendung nach dem Build zu starten.</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-string\">//</span> <span class=\"hljs-string\">...</span>\n  <span class=\"hljs-string\">&quot;scripts&quot;</span>: {\n    <span class=\"hljs-string\">//</span> <span class=\"hljs-string\">...</span>\n    <span class=\"hljs-string\">&quot;serve:ssr:book-monkey&quot;</span>: <span class=\"hljs-string\">&quot;node dist/book-monkey/server/server.mjs&quot;</span>\n  }\n}\n</code></pre>\n<p>Der gesamte Build wird nun mit dem gewohnten Befehl <code>ng build</code> angestoßen und beinhaltet auch den Teil für den Server und die statisch generierten HTML-Dateien für Pre-Rendering.\nDas Verhalten können wir in der Datei <code>angular.json</code> konfigurieren.</p>\n<h3 id=\"konfiguration-in-der-datei-angularjson\">Konfiguration in der Datei <code>angular.json</code></h3>\n<p>In der Datei <code>angular.json</code> wird der Application Builder konfiguriert.\nBisher waren hier einzelne <em>Build Targets</em> für SSR und Pre-Rendering notwendig. Der neue Builder vereint alle Teile unter dem Target <code>build</code>.\nDas bedeutet auch, dass nur noch der Befehl <code>ng build</code> notwendig ist, um den gesamten Build auszuführen. Dabei wird die Anwendung also nicht nur für den Browser gebaut, sondern es wird auch der Node.js-Server für SSR generiert, und die statischen HTML-Dateien aus den Routen werden mithilfe von Pre-Rendering erzeugt.</p>\n<p>SSR und Pre-Rendering können in der <code>angular.json</code> separat aktiviert und gesteuert werden.\nDie folgenden neuen Einträge sind hier nach der Einrichtung zu finden:</p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-string\">&quot;projects&quot;</span>: {\n    <span class=\"hljs-string\">&quot;book-monkey&quot;</span>: {\n      <span class=\"hljs-string\">&quot;architect&quot;</span>: {\n        <span class=\"hljs-string\">&quot;build&quot;</span>: {\n          <span class=\"hljs-string\">//</span> <span class=\"hljs-string\">...</span>\n          <span class=\"hljs-string\">&quot;server&quot;</span>: <span class=\"hljs-string\">&quot;src/main.server.ts&quot;</span>,\n          <span class=\"hljs-string\">&quot;prerender&quot;</span>: <span class=\"hljs-literal\">true</span>,\n          <span class=\"hljs-string\">&quot;ssr&quot;</span>: {\n            <span class=\"hljs-string\">&quot;entry&quot;</span>: <span class=\"hljs-string\">&quot;server.ts&quot;</span>\n          }\n        }\n      }\n    }\n  }\n}\n</code></pre>\n<h3 id=\"pre-rendering-konfigurieren\">Pre-Rendering konfigurieren</h3>\n<p>Im Buch haben wir gezeigt, wie wir die Liste der Routen für Pre-Rendering manuell übergeben können.\nAb sofort muss diese Liste in einer Datei abgelegt und in der <code>angular.json</code> referenziert werden.\nAnstatt dem Wert <code>true</code> können wir für <code>prerender</code> das folgende Konfigurationsobjekt übergeben:</p>\n<pre><code class=\"language-json\"><span class=\"hljs-attr\">&quot;prerender&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">{</span>\n  <span class=\"hljs-attr\">&quot;discoverRoutes&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><span class=\"hljs-punctuation\">,</span>\n  <span class=\"hljs-attr\">&quot;routesFile&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;routes.txt&quot;</span>\n<span class=\"hljs-punctuation\">}</span><span class=\"hljs-punctuation\">,</span>\n</code></pre>\n<p>Die Datei <code>routes.txt</code> liegt im Root-Verzeichnis des Projekts und hat den folgenden Inhalt.\nBisher hatten wir diese Liste in der <code>angular.json</code> definiert.</p>\n<pre><code>/\n/home\n/books\n/books/9783864909467\n/books/9783864907791\n/books/9783864906466\n/books/9783864903571\n</code></pre>\n<h3 id=\"sonstige-änderungen\">Sonstige Änderungen</h3>\n<ul>\n<li>Die Datei <code>server.ts</code> beinhaltet weiterhin einen Express-Server für den SSR-Prozess. Hier wird nun allerdings die neue <code>CommonEngine</code> aus dem Paket <code>@angular/ssr</code> verwendet. Der Aufbau wird dadurch vereinfacht.</li>\n<li>Im <code>AppModule</code> wird automatisch der Eintrag <code>provideClientHydration()</code> unter <code>providers</code> hinzugefügt. Damit wird die Client-Side Hydration aktiviert. Wir haben darüber im <a href=\"/blog/2023-05-angular16\">Blogpost zu Angular 16</a> berichtet.</li>\n<li>Die Datei <code>app.server.module.ts</code> wurde umbenannt zu <code>app.module.server.ts</code>. Der Inhalt ist weiterhin derselbe.</li>\n</ul>\n<h2 id=\"bestehendes-projekt-updaten\">Bestehendes Projekt updaten</h2>\n<p>Wenn Sie ein bestehendes Projekt auf Angular 17 aktualisieren, sorgen die Migrationsskripte hinter <code>ng update</code> dafür, dass automatisch das neue Paket <code>@angular/ssr</code> verwendet wird.\nDabei wird allerdings nicht automatisch der neue Application Builder eingerichtet, sondern es werden weiterhin die bisherigen Builder für SSR und Pre-Rendering genutzt, die in das Paket <code>@angular-devkit/build-angular</code> umgezogen wurden.</p>\n<pre><code>❯ Replace usages <span class=\"hljs-keyword\">of</span> <span class=\"hljs-string\">&#x27;@nguniversal/builders&#x27;</span> <span class=\"hljs-keyword\">with</span> <span class=\"hljs-string\">&#x27;@angular-devkit/build-angular&#x27;</span>.\n<span class=\"hljs-keyword\">UPDATE</span> angular.json (<span class=\"hljs-number\">5182</span> bytes)\n<span class=\"hljs-keyword\">UPDATE</span> package.json (<span class=\"hljs-number\">1903</span> bytes)\n  Migration completed (<span class=\"hljs-number\">2</span> files modified).\n\n❯ Replace usages <span class=\"hljs-keyword\">of</span> <span class=\"hljs-string\">&#x27;@nguniversal/&#x27;</span> packages <span class=\"hljs-keyword\">with</span> <span class=\"hljs-string\">&#x27;@angular/ssr&#x27;</span>.\n<span class=\"hljs-keyword\">RENAME</span> <span class=\"hljs-keyword\">server</span>.ts =&gt; <span class=\"hljs-keyword\">server</span>.ts.bak\n<span class=\"hljs-keyword\">CREATE</span> <span class=\"hljs-keyword\">server</span>.ts (<span class=\"hljs-number\">2206</span> bytes)\n<span class=\"hljs-keyword\">UPDATE</span> package.json (<span class=\"hljs-number\">1887</span> bytes)\n✔ Packages installed successfully.\n  Migration completed (<span class=\"hljs-number\">2</span> files modified).\n</code></pre>\n<p>Wenn Sie von hier aus den Application Builder nutzen möchten, ist eine manuelle Migration notwendig.\nDie grundlegenden Schritte haben wir im <a href=\"/blog/2023-11-angular17\">Blogpost zu Angular 17</a> beschrieben.</p>\n<h2 id=\"fazit\">Fazit</h2>\n<p>Die Einrichtung und Konfiguration von SSR und Pre-Rendering funktioniert mit Angular 17 und dem neuen Application Builder anders als zuvor.\nFür bestehende Projekte ist damit zwar etwas Aufwand zur Migration nötig – wir begrüßen allerdings sehr, dass der Build-Prozess harmonisiert wird und das Thema SSR mehr in den Fokus rückt.</p>\n<p>Sie können weiterhin auch die bestehenden Builder nutzen, die aus dem Paket <code>@nguniversal/express-engine</code> nach <code>@angular-devkit/build-angular</code> verschoben wurden.\nDennoch empfehlen wir Ihnen den Umstieg auf den Application Builder, um alle Vorteile und Optimierungen sofort zu nutzen.</p>\n<p>An den konzeptionellen Grundlagen zu SSR, die wir im Buch ausführlich beschrieben haben, ändert sich darüber hinaus nichts.\nDer Ablauf ist noch immer der gleiche – nur die Umsetzung im Code hat sich mit Angular 17 geändert.</p>\n<hr>\n\n<p><small><strong>Titelbild:</strong> Photo by <a href=\"https://unsplash.com/@fotograw\">Dmitriy Demidov</a> on <a href=\"https://unsplash.com/s/photos/wrench\">Unsplash</a></small></p>\n","meta":{"title":"Book Monkey v5: Server-Side Rendering mit Angular 17","author":"Ferdinand Malcher","mail":"ferdinand@malcher.media","published":"2023-11-21T00:00:00.000Z","lastModified":"2023-11-21T00:00:00.000Z","keywords":["Server-Side Rendering","Pre-Rendering","ESBuild","Application Builder","BookMonkey"],"language":"de","header":{"url":"bm.jpg","width":2000,"height":645}}}
